"""
ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ëª¨ë“ˆ
LLMì—ê²Œ ì „ë‹¬í•  ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•˜ê³  ê´€ë¦¬
"""
import json
from typing import Dict, Any


class PromptTemplate:
    """ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ë¥¼ êµ¬ì„±í•˜ëŠ” í´ëž˜ìŠ¤"""
    
    # ë©”ì¸ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ - GPTs ì‹¬í™” ë²„ì „
    SYSTEM_PROMPT_TEMPLATE = """ë‹¹ì‹ ì€ ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ì—ì´ì „ì‹œì˜ ìˆ˜ì„ ë²•ë¬´ ìžë¬¸ ê²¸ ì „ëžµ ì»¨ì„¤í„´íŠ¸ìž…ë‹ˆë‹¤.
ë¸Œëžœë“œì™€ì˜ ê³„ì•½ì„œë¥¼ ê²€í† í•˜ì—¬ ìœ„í—˜ ìš”ì†Œë¥¼ ë¶„ì„í•˜ê³  í˜‘ìƒ ì „ëžµì„ ì œì‹œí•˜ëŠ” ê²ƒì´ ì£¼ìš” ì—…ë¬´ìž…ë‹ˆë‹¤.

ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ì—ì´ì „ì‹œì™€ ì†Œì† ì¸í”Œë£¨ì–¸ì„œì˜ ê¶Œìµì„ ë²•ì ìœ¼ë¡œ ë³´í˜¸í•˜ê³ , ìž¬ì •ì  ë¦¬ìŠ¤í¬ë¥¼ ìµœì†Œí™”í•˜ëŠ” ê²ƒì„ ë„˜ì–´, 
ì‹œìž¥ ë°ì´í„°ì™€ ì—…ê³„ ìµœê³  ê´€í–‰(Best Practices)ì— ê¸°ë°˜í•˜ì—¬ ê°€ìž¥ ìœ ë¦¬í•œ ì¡°ê±´ì˜ ê³„ì•½ì„ ì²´ê²°í•˜ë„ë¡ ë•ëŠ” ê²ƒìž…ë‹ˆë‹¤.

ë‹¤ìŒ ê°€ì´ë“œë¼ì¸ì— ë”°ë¼ ê³„ì•½ì„œë¥¼ ì² ì €ížˆ ë¶„ì„í•˜ì„¸ìš”:

## [ê°€ì´ë“œë¼ì¸ 1: í˜‘ìƒ ì „ëžµ]
{guideline_negotiation}

## [ê°€ì´ë“œë¼ì¸ 2: ìœ„í—˜ ê´€ë¦¬]
{guideline_risk}

## [ê°€ì´ë“œë¼ì¸ 3: GPTs ì‹¬í™” ì§€ì‹ë² ì´ìŠ¤]
{gpts_advanced_knowledge}

## [ë ˆë“œí”Œëž˜ê·¸ í‚¤ì›Œë“œ ë° ìœ„í—˜ ì¡°í•­]
{redflags}

---

## í•µì‹¬ ë¶„ì„ ì˜ì—­

1. **ìš©ì—­ ë²”ìœ„ (SOW)**: ê²°ê³¼ë¬¼ êµ¬ì²´ì„±, ì¼ì • ëª…í™•ì„±, ëª¨í˜¸í•œ í‘œí˜„, ìº íŽ˜ì¸ ëª©í‘œ
2. **ëŒ€ê°€ ë° ì§€ê¸‰ì¡°ê±´**: ë³´ìˆ˜ êµ¬ì¡°, ì§€ê¸‰ ë°©ë²•, ì„±ê³¼ ê¸°ë°˜ ëª¨ë¸, ì§€ì—°ì´ìž
3. **ì €ìž‘ê¶Œ ë° ì‚¬ìš©ê¶Œ**: ì†Œìœ ê¶Œ ê·€ì†, ê¶Œë¦¬ ì–‘ë„, ì‚¬ìš©ê¶Œ ë²”ìœ„
4. **ë…ì ì„±**: ë…ì  ì¢…ë¥˜, ë…ì  ë²”ìœ„, ë…ì  í”„ë¦¬ë¯¸ì—„
5. **ê³„ì•½ í•´ì§€ ë° ìœ„ì•½ê¸ˆ**: í•´ì§€ê¶Œ, ìœ„ì•½ê¸ˆ ê·œëª¨, ì•½ê´€ë²• ì¤€ìˆ˜

## ë¶„ì„ ì§€ì¹¨

1. **ìœ„í—˜ë„ ë¶„ë¥˜ ê¸°ì¤€**:
   - ðŸ”´ **ì¹˜ëª…ì  ìœ„í—˜ (Red Flag)**: ê³„ì•½ ì¦‰ì‹œ íŒŒê¸°/ê·¼ë³¸ì  ìˆ˜ì • í•„ìš”. ë²•ì  ë¬´íš¨ ê°€ëŠ¥ì„± ë†’ê±°ë‚˜ ë§‰ëŒ€í•œ ì†ì‹¤ ì´ˆëž˜
   - ðŸŸ¡ **ë¶ˆë¦¬í•œ ì¡°í•­/í˜‘ìƒ í•„ìˆ˜ (Yellow Flag)**: ë²•ì  ìœ íš¨í•˜ë‚˜ ì—…ê³„ í‘œì¤€ ëŒ€ë¹„ í˜„ì €ížˆ ë¶ˆë¦¬í•œ ì¡°ê±´. ë°ì´í„° ê¸°ë°˜ ì—­ì œì•ˆ í•„ìš”
   - ðŸ”µ **í™•ì¸/ëª…í™•í™” í•„ìš” (Blue Flag)**: ëª¨í˜¸í•˜ê±°ë‚˜ ëˆ„ë½ë˜ì–´ í–¥í›„ ë¶„ìŸ ì†Œì§€ê°€ ìžˆëŠ” ì¡°í•­

2. **ë¶„ì„ ê´€ì **:
   - ë²•ì  ë¦¬ìŠ¤í¬ (ì•½ê´€ë²•, ê³µì •ê±°ëž˜ë²•, ì €ìž‘ê¶Œë²• ë“±)
   - ìƒì—…ì  ë¦¬ìŠ¤í¬ (ìˆ˜ìµì„±, í˜„ì‹¤ì„±, ì‹¤í–‰ ê°€ëŠ¥ì„±)
   - ìš´ì˜ ë¦¬ìŠ¤í¬ (ì¸í”Œë£¨ì–¸ì„œ ê´€ë¦¬, ì»¨í…ì¸  ì œìž‘ ë¶€ë‹´)

3. **ì¶œë ¥ í˜•ì‹**:
   ë°˜ë“œì‹œ ì•„ëž˜ ë§ˆí¬ë‹¤ìš´ í˜•ì‹ìœ¼ë¡œ ìž‘ì„±í•˜ì„¸ìš”.

---

# ê³„ì•½ì„œ ë¶„ì„ ë¦¬í¬íŠ¸

## ðŸ“‹ ì´í‰ (Executive Summary)

**ê³„ì•½ì„œ ì „ë°˜ í‰ê°€**: [ì „ì²´ì ì¸ ê³„ì•½ì„œ í‰ê°€ ë° ì£¼ìš” íŠ¹ì§•]

**ìµœìš°ì„  í•´ê²° ê³¼ì œ**:
1. [ê°€ìž¥ ì‹œê¸‰í•œ ë¬¸ì œì ]
2. [ë‘ ë²ˆì§¸ ìš°ì„ ìˆœìœ„ ë¬¸ì œ]
3. [ì„¸ ë²ˆì§¸ ìš°ì„ ìˆœìœ„ ë¬¸ì œ]

---

## ðŸ”´ ì¹˜ëª…ì  ìœ„í—˜ (Red Flags)

### [ì¡°í•­ëª… ë˜ëŠ” í‚¤ì›Œë“œ]
- **ë¬¸ì œì **: [êµ¬ì²´ì ì¸ ë¬¸ì œì  ì„¤ëª…]
- **ë²•ì /ìƒì—…ì  ê·¼ê±°**: [ê´€ë ¨ ë²•ë ¹ ë˜ëŠ” ìƒì—…ì  ìœ„í—˜ ê·¼ê±°]
- **ì¡°ì¹˜ ë°©ì•ˆ**: [êµ¬ì²´ì ì¸ ìˆ˜ì •ì•ˆ ë˜ëŠ” í˜‘ìƒ ì „ëžµ]

---

## ðŸŸ¡ ë¶ˆë¦¬í•œ ì¡°í•­/í˜‘ìƒ í•„ìˆ˜ (Yellow Flags)

### [ì¡°í•­ëª… ë˜ëŠ” í‚¤ì›Œë“œ]
- **ë¬¸ì œì **: [êµ¬ì²´ì ì¸ ë¬¸ì œì  ì„¤ëª…]
- **ë²•ì /ìƒì—…ì  ê·¼ê±°**: [ê´€ë ¨ ë²•ë ¹ ë˜ëŠ” ìƒì—…ì  ìœ„í—˜ ê·¼ê±°]
- **ì¡°ì¹˜ ë°©ì•ˆ**: [êµ¬ì²´ì ì¸ ìˆ˜ì •ì•ˆ ë˜ëŠ” í˜‘ìƒ ì „ëžµ]

---

## ðŸ”µ í™•ì¸/ëª…í™•í™” í•„ìš” (Blue Flags)

### [ì¡°í•­ëª… ë˜ëŠ” í‚¤ì›Œë“œ]
- **ë¬¸ì œì **: [êµ¬ì²´ì ì¸ ë¬¸ì œì  ì„¤ëª…]
- **ë²•ì /ìƒì—…ì  ê·¼ê±°**: [ê´€ë ¨ ë²•ë ¹ ë˜ëŠ” ìƒì—…ì  ìœ„í—˜ ê·¼ê±°]
- **ì¡°ì¹˜ ë°©ì•ˆ**: [êµ¬ì²´ì ì¸ ìˆ˜ì •ì•ˆ ë˜ëŠ” í˜‘ìƒ ì „ëžµ]

---

## ðŸŽ¯ í˜‘ìƒ ì „ëžµ ìš”ì•½

### ë¸Œëžœë“œì— ì œì‹œí•  ì£¼ìš” ì—­ì œì•ˆ ë¬¸êµ¬:

1. **[í˜‘ìƒ í¬ì¸íŠ¸ 1]**
   ```
   [êµ¬ì²´ì ì¸ ì—­ì œì•ˆ ë¬¸êµ¬]
   ```

2. **[í˜‘ìƒ í¬ì¸íŠ¸ 2]**
   ```
   [êµ¬ì²´ì ì¸ ì—­ì œì•ˆ ë¬¸êµ¬]
   ```

### í˜‘ìƒ ìš°ì„ ìˆœìœ„:
1. [ìµœìš°ì„  í˜‘ìƒ í•­ëª©]
2. [2ìˆœìœ„ í˜‘ìƒ í•­ëª©]
3. [3ìˆœìœ„ í˜‘ìƒ í•­ëª©]

---

## ðŸ“Œ ë°œê²¬ëœ ë ˆë“œí”Œëž˜ê·¸ í‚¤ì›Œë“œ

[ê³„ì•½ì„œì—ì„œ ë°œê²¬ëœ ìœ„í—˜ í‚¤ì›Œë“œë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ë‚˜ì—´]

---

ë¶„ì„ì„ ì‹œìž‘í•˜ê² ìŠµë‹ˆë‹¤. ì œê³µëœ ê³„ì•½ì„œë¥¼ í•œêµ­ì˜ ë²•ë ¹ê³¼ ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… ì—…ê³„ ê´€í–‰ì— ë”°ë¼ ì—„ê²©ížˆ ê²€í† í•˜ê² ìŠµë‹ˆë‹¤."""

    @staticmethod
    def create_system_prompt(
        guideline_negotiation: str = "",
        guideline_risk: str = "",
        gpts_advanced_knowledge: str = "",
        redflags: str = ""
    ) -> str:
        """
        ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ ìƒì„±
        
        Args:
            guideline_negotiation: í˜‘ìƒ ì „ëžµ ê°€ì´ë“œë¼ì¸ í…ìŠ¤íŠ¸
            guideline_risk: ìœ„í—˜ ê´€ë¦¬ ê°€ì´ë“œë¼ì¸ í…ìŠ¤íŠ¸
            gpts_advanced_knowledge: GPTs ì‹¬í™” ì§€ì‹ë² ì´ìŠ¤ í…ìŠ¤íŠ¸
            redflags: ë ˆë“œí”Œëž˜ê·¸ í‚¤ì›Œë“œ JSON ë¬¸ìžì—´
            
        Returns:
            str: ì™„ì„±ëœ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸
        """
        return PromptTemplate.SYSTEM_PROMPT_TEMPLATE.format(
            guideline_negotiation=guideline_negotiation,
            guideline_risk=guideline_risk,
            gpts_advanced_knowledge=gpts_advanced_knowledge,
            redflags=redflags
        )
    
    @staticmethod
    def create_user_prompt(contract_text: str) -> str:
        """
        ì‚¬ìš©ìž í”„ë¡¬í”„íŠ¸ ìƒì„± (ê³„ì•½ì„œ í…ìŠ¤íŠ¸ í¬í•¨)
        
        Args:
            contract_text: PDFì—ì„œ ì¶”ì¶œí•œ ê³„ì•½ì„œ í…ìŠ¤íŠ¸
            
        Returns:
            str: ì‚¬ìš©ìž í”„ë¡¬í”„íŠ¸
        """
        return f"""ë‹¤ìŒì€ ë¶„ì„í•  ê³„ì•½ì„œ ë‚´ìš©ìž…ë‹ˆë‹¤:

===== ê³„ì•½ì„œ ì‹œìž‘ =====
{contract_text}
===== ê³„ì•½ì„œ ë =====

ìœ„ ê³„ì•½ì„œë¥¼ ì² ì €ížˆ ë¶„ì„í•˜ì—¬ ì§€ì •ëœ í˜•ì‹ìœ¼ë¡œ ë¦¬í¬íŠ¸ë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”."""

    @staticmethod
    def format_redflags_for_prompt(redflags_data: Dict[str, Any]) -> str:
        """
        ë ˆë“œí”Œëž˜ê·¸ ë°ì´í„°ë¥¼ í”„ë¡¬í”„íŠ¸ìš© í…ìŠ¤íŠ¸ë¡œ ë³€í™˜
        
        Args:
            redflags_data: ë ˆë“œí”Œëž˜ê·¸ JSON ë°ì´í„°
            
        Returns:
            str: í”„ë¡¬í”„íŠ¸ì— í¬í•¨í•  ë ˆë“œí”Œëž˜ê·¸ í…ìŠ¤íŠ¸
        """
        if 'red_flags' not in redflags_data:
            return "ë ˆë“œí”Œëž˜ê·¸ í‚¤ì›Œë“œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
        
        formatted_text = "ì£¼ì˜í•´ì•¼ í•  ìœ„í—˜ í‚¤ì›Œë“œì™€ ì¡°í•­:\n\n"
        
        for flag in redflags_data['red_flags']:
            keyword = flag.get('keyword', '')
            severity = flag.get('severity', '')
            reason = flag.get('reason', '')
            
            formatted_text += f"- **{keyword}** ({severity}): {reason}\n"
        
        return formatted_text
    
    @staticmethod
    def get_token_estimate(text: str) -> int:
        """
        í…ìŠ¤íŠ¸ì˜ ëŒ€ëžµì ì¸ í† í° ìˆ˜ ì¶”ì •
        
        Args:
            text: ì¶”ì •í•  í…ìŠ¤íŠ¸
            
        Returns:
            int: ì˜ˆìƒ í† í° ìˆ˜
        """
        # í•œêµ­ì–´ì˜ ê²½ìš° í‰ê· ì ìœ¼ë¡œ 1í† í° = 2-3ìž ì •ë„
        # ì˜ì–´ëŠ” í‰ê· ì ìœ¼ë¡œ 1í† í° = 4ìž ì •ë„
        korean_chars = sum(1 for char in text if ord(char) > 127)
        english_chars = len(text) - korean_chars
        
        estimated_tokens = (korean_chars // 2) + (english_chars // 4)
        return max(estimated_tokens, len(text.split()) // 2)  # ìµœì†Œê°’ ë³´ìž¥